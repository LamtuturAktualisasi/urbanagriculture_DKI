<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum=1,width=device-width">
  <link rel="stylesheet" href="./resources/ol.css">
  <link rel="stylesheet" href="resources/fontawesome-all.min.css">
  <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
  <link rel="stylesheet" href="./resources/qgis2web.css">
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
    #map { width:100vw; height:100vh; }
    .ol-control { background-color: rgba(255,255,255,0.4)!important; padding:2px!important; }
    .ol-control > * { background-color:#f8f8f8!important; color:#444!important; border-radius:0; }
    .ol-control > *:focus, .ol-control > *:hover { background-color:rgba(248,248,248,0.7)!important; }
    .layer-switcher { top:10px!important; right:10px!important; }
    /* Popup */
    .ol-popup {
      position: absolute;
      background-color: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #cccccc;
      min-width: 260px;
    }
    .ol-popup-closer {
      text-decoration: none;
      position: absolute;
      top: 2px;
      right: 8px;
    }
    /* Legend kiri-bawah DIHAPUS, jadi tidak ada style/elemen legend-container lagi */
  </style>
  <title>Peta Urban Agriculture</title>
</head>
<body>
  <div id="map">
    <div id="popup" class="ol-popup" style="display:none;">
      <a href="#" id="popup-closer" class="ol-popup-closer">âœ•</a>
      <div id="popup-content"></div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  <script src="resources/photon-geocoder-autocomplete.min.js"></script>

  <!-- LAYERS (punya Anda sendiri dari qgis2web) -->
  <script src="layers/KesesuaianUrbanAgriculture20_1.js"></script>
  <script src="layers/KesesuaianUrbanAgriculture10_2.js"></script>
  <script src="layers/BatasKabupaten_3.js"></script>
  <script src="styles/KesesuaianUrbanAgriculture20_1_style.js"></script>
  <script src="styles/KesesuaianUrbanAgriculture10_2_style.js"></script>
  <script src="styles/BatasKabupaten_3_style.js"></script>
  <script src="./layers/layers.js"></script>
  <script src="./resources/Autolinker.min.js"></script>

  <script>
    // ----- Base map
    const baseGoogle = new ol.layer.Tile({
      title: 'Google Satelit',
      type: 'base',
      visible: true,
      source: new ol.source.XYZ({
        url: 'http://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'
      })
    });

    // ----- Layers dari qgis2web
    const batasKabupaten = lyr_BatasKabupaten_3;
    batasKabupaten.setZIndex(10);
    batasKabupaten.setStyle(new ol.style.Style({
      stroke: new ol.style.Stroke({ color: '#000000', width: 2 }),
      fill: null
    }));

    const ua10 = lyr_KesesuaianUrbanAgriculture10_2; // default ditampilkan
    const ua20 = lyr_KesesuaianUrbanAgriculture20_1;

    ua10.setVisible(true);
    ua20.setVisible(false);

    // ----- Map
    const map = new ol.Map({
      target: 'map',
      layers: [baseGoogle, batasKabupaten, ua10, ua20],
      view: new ol.View({
        center: ol.proj.fromLonLat([106.8456, -6.2088]), // fallback Jakarta
        zoom: 11
      }),
      controls: ol.control.defaults().extend([
        new ol.control.LayerSwitcher({ tipLabel: 'Layer', groupSelectStyle: 'children' })
      ])
    });

    // Fit ke extent DKI (dari layer kesesuaian yang aktif)
    const fitToJakarta = () => {
      const src = (ua10.getVisible() ? ua10 : ua20).getSource();
      const extent = src.getExtent();
      if (extent && extent.every(Number.isFinite)) {
        map.getView().fit(extent, { size: map.getSize(), padding: [50,50,50,50], duration: 500 });
      }
    };
    // Setelah map siap
    map.once('postrender', fitToJakarta);

    // ----- Hover style
    const hoverStyle = new ol.style.Style({
      stroke: new ol.style.Stroke({ color: 'yellow', width: 2 }),
      fill: new ol.style.Fill({ color: 'rgba(255,255,0,0.3)' })
    });
    const selectPointerMove = new ol.interaction.Select({
      condition: ol.events.condition.pointerMove,
      style: hoverStyle,
      layers: [ua10, ua20]
    });
    map.addInteraction(selectPointerMove);

    // ----- Popup
    const container = document.getElementById('popup');
    const content   = document.getElementById('popup-content');
    const closer    = document.getElementById('popup-closer');

    const overlay = new ol.Overlay({
      element: container,
      autoPan: true,
      autoPanAnimation: { duration: 250 }
    });
    map.addOverlay(overlay);

    closer.onclick = function () {
      overlay.setPosition(undefined);
      container.style.display = 'none';
      closer.blur();
      return false;
    };

    // helper untuk aman ambil properti
    const g = (p, k, alt='-') => (p[k] !== undefined && p[k] !== null && p[k] !== '') ? p[k] : alt;

    map.on('singleclick', function(evt) {
      const feature = map.forEachFeatureAtPixel(evt.pixel, function(feat, layer) {
        if (layer === ua10 || layer === ua20) return feat;
      });

      if (feature) {
        const p = feature.getProperties();

        // Ganti nama field di bawah sesuai dengan atribut Anda persis (periksa di GeoJSON dari layer.js)
        const html = `
          <b>Kategori Kesesuaian:</b> ${g(p, 'Kategori_Kesesuaian', g(p, 'Kategori', '-'))}<br>
          <b>Kelurahan:</b> ${g(p, 'Kelurahan')}<br>
          <b>Kecamatan:</b> ${g(p, 'Kecamatan')}<br>
          <b>Kota:</b> ${g(p, 'Kota')}<br>
          <b>Nilai Ecological Environment:</b> ${g(p, 'Ecological_Env', g(p, 'Nilai_Ecological_Enviroment'))}<br>
          <b>Social Demand:</b> ${g(p, 'Sosial_Demand', g(p, 'Social_Demand'))}<br>
          <b>Investment Cost:</b> ${g(p, 'Investment_Cost')}<br>
          <b>Nilai Kesesuaian:</b> ${g(p, 'Nilai_Kesesuaian')}<br>
          <hr style="margin:6px 0;">
          <small><i>Waktu: ${new Date().toLocaleString('id-ID')}</i></small>
        `;

        content.innerHTML = html;
        container.style.display = 'block';
        overlay.setPosition(evt.coordinate);
      } else {
        overlay.setPosition(undefined);
        container.style.display = 'none';
      }
    });

    // Jika user menukar layer (ua10 <-> ua20), refit extent
    [ua10, ua20].forEach(l => {
      l.on('change:visible', () => {
        if (l.getVisible()) setTimeout(fitToJakarta, 100);
      });
    });
  </script>
</body>
</html>
