<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- CSS dari qgis2web / OpenLayers -->
  <link rel="stylesheet" href="./resources/ol.css">
  <link rel="stylesheet" href="resources/fontawesome-all.min.css">
  <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
  <link rel="stylesheet" href="./resources/qgis2web.css">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #ffffff;
    }
    #map {
      width: 100%;
      height: 100%;
    }

    /* Tetap pakai LayerSwitcher kanan-atas seperti bawaan qgis2web */
    .ol-control {
      background-color: rgba(255,255,255,.4) !important;
      padding: 2px !important;
    }
    .ol-control > * {
      background-color: #f8f8f8!important;
      color: #444444!important;
      border-radius: 0px;
    }
    .ol-control > *:focus, .ol-control > *:hover {
      background-color: rgba(248, 248, 248, 0.7)!important;
    }
    .layer-switcher {
      top: 10px !important;
      right: 10px !important;
    }

    /* Popup */
    .ol-popup {
      position: absolute;
      background-color: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #cccccc;
      min-width: 260px;
    }
    .ol-popup-closer {
      text-decoration: none;
      position: absolute;
      top: 2px;
      right: 8px;
      font-weight: bold;
    }
    .ol-popup-closer:after { content: "✕"; }
  </style>

  <title>Peta Urban Agriculture DKI Jakarta</title>
</head>
<body>
  <div id="map">
    <div id="popup" class="ol-popup" style="display:none;">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>
  </div>

  <!-- JS libs -->
  <script src="resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  <script src="resources/photon-geocoder-autocomplete.min.js"></script>

  <!-- LAYERS dari qgis2web -->
  <script src="layers/KesesuaianUrbanAgriculture20_1.js"></script>
  <script src="layers/KesesuaianUrbanAgriculture10_2.js"></script>
  <script src="layers/BatasKabupaten_3.js"></script>
  <script src="styles/KesesuaianUrbanAgriculture20_1_style.js"></script>
  <script src="styles/KesesuaianUrbanAgriculture10_2_style.js"></script>
  <script src="styles/BatasKabupaten_3_style.js"></script>
  <script src="./layers/layers.js"></script>

  <script src="./resources/Autolinker.min.js"></script>

  <script>
    // ===== Base map Google
    const baseGoogle = new ol.layer.Tile({
      title: 'Google Satelit',
      type: 'base',
      visible: true,
      source: new ol.source.XYZ({
        url: 'http://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'
      })
    });

    // ===== Layers (nama variabel mengikuti hasil export qgis2web)
    const ua20 = lyr_KesesuaianUrbanAgriculture20_1;
    const ua10 = lyr_KesesuaianUrbanAgriculture10_2;
    const batasKabupaten = lyr_BatasKabupaten_3;

    // Tampilkan 1.0 saat awal, 2.0 disembunyikan
    ua10.setVisible(true);
    ua20.setVisible(false);

    // Garis batas tebal
    batasKabupaten.setZIndex(10);
    batasKabupaten.setStyle(new ol.style.Style({
      stroke: new ol.style.Stroke({ color: '#000000', width: 2 }),
      fill: null
    }));

    // ===== Buat peta
    const map = new ol.Map({
      target: 'map',
      layers: [baseGoogle, batasKabupaten, ua10, ua20],
      view: new ol.View({
        // Fokus langsung ke DKI (daratan) – tidak pakai fit supaya tidak ikut Kep. Seribu
        center: ol.proj.fromLonLat([106.8456, -6.2088]), // Monas-ish
        zoom: 12
      }),
      controls: ol.control.defaults().extend([
        new ol.control.LayerSwitcher({ tipLabel: 'Layer', groupSelectStyle: 'children' })
      ])
    });

    // ===== Hover style
    const hoverStyle = new ol.style.Style({
      stroke: new ol.style.Stroke({ color: 'yellow', width: 2 }),
      fill: new ol.style.Fill({ color: 'rgba(255,255,0,0.3)' })
    });
    const selectPointerMove = new ol.interaction.Select({
      condition: ol.events.condition.pointerMove,
      style: hoverStyle,
      layers: [ua10, ua20]
    });
    map.addInteraction(selectPointerMove);

    // ===== Popup
    const container = document.getElementById('popup');
    const content   = document.getElementById('popup-content');
    const closer    = document.getElementById('popup-closer');

    const overlay = new ol.Overlay({
      element: container,
      autoPan: true,
      autoPanAnimation: { duration: 250 }
    });
    map.addOverlay(overlay);

    closer.onclick = function () {
      overlay.setPosition(undefined);
      container.style.display = 'none';
      closer.blur();
      return false;
    };

    function safe(v) {
      return (v === undefined || v === null || v === '') ? '-' : v;
    }

    map.on('singleclick', function(evt) {
      let clickedLayer = null;
      const feature = map.forEachFeatureAtPixel(evt.pixel, function(feat, layer) {
        if (layer === ua10 || layer === ua20) {
          clickedLayer = layer;
          return feat;
        }
      });

      if (!feature) {
        overlay.setPosition(undefined);
        container.style.display = 'none';
        return;
      }

      const p = feature.getProperties();
      const title = (clickedLayer === ua10) ? 'Urban Agriculture 1.0' : 'Urban Agriculture 2.0';

      content.innerHTML = `
        <h3 style="margin:0 0 6px 0;">${title}</h3>
        <b>Kategori Kesesuaian:</b> ${safe(p.Keterangan)}<br>
        <b>Kelurahan:</b> ${safe(p.WADMKD)}<br>
        <b>Kecamatan:</b> ${safe(p.WADMKC)}<br>
        <b>Kota:</b> ${safe(p.WADMKK)}<br>
        <b>Nilai Ecological Environment:</b> ${safe(p.Ecological)}<br>
        <b>Social Demand:</b> ${safe(p['Sosial Dem'])}<br>
        <b>Investment Cost:</b> ${safe(p.Investment)}<br>
        <b>Nilai Kesesuaian:</b> ${safe(p.Kesesuaian)}
      `;

      container.style.display = 'block';
      overlay.setPosition(evt.coordinate);
    });

    // Jika Anda tetap ingin tombol/aksi untuk refit ke DKI saja kapan pun:
    // function refitJakarta() {
    //   const extent = ol.proj.transformExtent([106.69, -6.39, 106.99, -6.05], 'EPSG:4326', 'EPSG:3857');
    //   map.getView().fit(extent, { padding: [40,40,40,40], duration: 300 });
    // }
  </script>
</body>
</html>
